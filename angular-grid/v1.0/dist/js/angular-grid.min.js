angular.module("ui.grid",["ngDatetime"]).factory("TableHelper",[function(){var t={};return t.throttled=function(t,e,a){var n,i,l,r=null,s=0;a||(a={});var o=function(){s=a.leading===!1?0:Date.now||(new Date).getTime(),r=null,l=t.apply(n,i),r||(n=i=null)};return function(){var c=Date.now||(new Date).getTime();s||a.leading!==!1||(s=c);var d=e-(c-s);return n=this,i=arguments,d<=0||d>e?(r&&(clearTimeout(r),r=null),s=c,l=t.apply(n,i),r||(n=i=null)):r||a.trailing===!1||(r=setTimeout(o,d)),l}},t}]).factory("TableFactory",["$http","TableHelper",function(t,e){var a={};return a.defaultSettings={checkbox:!1},a.createTable=function(t,e){var n=angular.extend({},a.defaultSettings,t.settings),t=t.options;if(!e||0===e.length)return{tableList:[]};var i={};for(var l in e[0])e[0].hasOwnProperty(l)&&!t[l]&&(i[l]={hidden:!0});for(var l in t){var r=t[l].showDisplay;r&&!r()?t[l].hidden=!0:t[l].hidden=!1}t=angular.extend({},t,i);var s=function(){var e={};for(var a in t)e[a]=angular.extend({},t[a]);return e},o=function(e){var a={};for(var n in t)a[n]=e[n];return a},c=function(){for(var t=[],a=0;a<e.length;a++){var n=o(e[a]);d(n),t.push(n)}return t},d=function(e){for(var a in t)t[a].cellTemplate&&(e[a]=t[a].cellTemplate())},u={tableSettings:n,tableOptions:s(),tableList:c()};return u},a}]).filter("tdTrans",["TableHelper","dateTimeFactory",function(t,e){return function(t,a){if(null!==t&&""!==t||(t="-"),a.transValue){var n;if(angular.isFunction(a.transValue)){for(var i=a.transValue(),l={},r=i.list,s=i.key,o=i.value,c=0;c<r.length;c++)l[r[c][s]]=r[c][o];n=l[t]}else n=a.transValue[t];t=n||"-"}if(a.formatDate)try{t=e.format(e.newDate(t),a.formatDate)}catch(d){}return t}}]).directive("angularTable",function(){return{restrict:"EA",scope:{tableParams:"="},replace:!0,template:'<div class="table-responsive table-wrapper"> <angular-table-body table-list="tableParams.tableList" table-settings="tableParams.tableSettings" table-options="tableParams.tableOptions"> </angular-table-body><div class="resize-bar"></div></div>',link:function(t,e,a){}}}).directive("angularTableBody",["TableHelper","$document","$timeout",function(t,e,a){return{restrict:"EA",replace:!0,scope:{tableList:"=",tableSettings:"=",tableOptions:"="},template:'<table class="table table-bordered table-hover table-striped">    <thead class="table-header">       <tr>           <th class="th-checkbox" ng-if="::tableSettings.checkbox"><input type="checkbox" ng-click="checkAll()" ng-checked="isCheckAll" /></th>           <th class="th-unit" data-th-key="{{::key}}" ng-if="!item.hidden" ng-repeat="(key,item) in tableOptions" ng-style="{\'width\':item.width}" ng-class="{\'sort\':key===col}">              <span class="inner" ng-click="sort(key)"><span class="table-sort"  ng-class="{true:\'down\', false: \'up\'}[desc]"><span class="icon-caret-up"></span><span class="icon-caret-down"></span></span>              <span class="th-inner" ng-bind="::item.ChineseName"></span></span>              <span class="th-resize" ng-mousedown="mousedown(key,$event)"></span>           </th>       </tr>    </thead>    <tbody>    <tr class="table-row" ng-class="{\'selected\':tr.checked}" ng-repeat="tr in tableList|orderBy:col:desc">         <td class="td-checkbox" ng-if="::tableSettings.checkbox"><input type="checkbox" ng-model="tr.checked" ng-change="checkItem(tr)" /></td>         <td data-td-key="{{::key}}" class="td-unit" ng-repeat="(key,td) in tr" ng-if="::tableOptions[key] && !tableOptions[key].hidden">              <div ng-if="::tableOptions[key].cellTemplate" td-compile="::td" class="td-inner"></div>              <div ng-if="::!tableOptions[key].cellTemplate" ng-bind="::td|tdTrans:tableOptions[key]" title="{{::td|tdTrans:tableOptions[key]}}" class="td-inner td-text"></div>         </td>     </tr>    </tbody> </table>',link:function(n,i,l){function r(t){t.stopPropagation();var e=t.pageX;p.css({left:e-u.offset().left+u.scrollLeft()})}function s(t){t.preventDefault(),t.stopPropagation();var a=parseInt(p.offset().left)-d.offset().left,i=!1,l=d.find(".inner").outerWidth()+10,a=a<l?l:a;angular.forEach(n.tableOptions,function(t,e){if(i){var l=u.find("[data-th-key='"+e+"']").find(".inner");if(t.cellTemplate){var r=u.find("[data-td-key='"+e+"']").find(".td-inner"),s=0;r.each(function(){s=Math.max($(this).outerWidth(),s)});var o=Math.max(s+16,l.outerWidth()+10)}else var o=l.outerWidth()+10;var d=parseInt(n.tableOptions[e].width)+parseInt(n.tableOptions[c].width)-a;n.tableOptions[e].width=Math.max(d,o),i=!1}e!==c||i||(i=!0)}),n.tableOptions[c].width=a,n.$apply(),p.css({left:-999999999}),e.unbind("mousemove",r),e.unbind("mouseup",s)}function o(){var t=120,e=0,a=n.tableSettings&&n.tableSettings.checkbox?40:0,l=$(i).parent(".table-wrapper"),r=l.width()-2;if(angular.forEach(f,function(t,i){if(!n.tableOptions[i].hidden)if("auto"!==t.width)a+=parseInt(n.tableOptions[i].width);else if(angular.isFunction(t.cellTemplate)){var l=u.find("[data-td-key='"+i+"']").find(".td-inner"),r=u.find("[data-th-key='"+i+"']").find(".th-inner"),s=0;l.addClass("inline-block").each(function(){s=Math.max($(this).outerWidth(),s)}),n.tableOptions[i].width=Math.max(s+16,r.outerWidth()),a+=n.tableOptions[i].width}else e++}),0===e&&n.tableList&&n.tableList.length>0)throw"warning:表格至少需要一个宽度为auto的非html单元格";angular.forEach(f,function(i,l){if(!n.tableOptions[l].hidden&&"auto"===i.width&&e>0&&!i.cellTemplate){var s=(r-a)/e;n.tableOptions[l].width=Math.max(s,t)}})}n.gridScope=n.$parent.$parent,n.col="",n.desc="",n.sort=function(t){n.col=t,n.desc=!n.desc};var c,d,u=$(i).parent(),p=u.find(".resize-bar");n.mousedown=function(t,a){a.stopPropagation(),a.preventDefault(),c=t,d=$(a.target).parent(),e.bind("mousemove",r),e.bind("mouseup",s),p.css({left:a.pageX-u.offset().left+u.scrollLeft()})};var f,h=t.throttled(function(){o(),n.$apply()},500);$(window).resize(h),$(window).on("window-resize",h),n.$watch("tableList",function(t,e){t!==e&&(f=angular.copy(n.tableOptions),a(function(){o()},0),n.isCheckAll=!1)}),n.checkItem=function(t){var e=!0;angular.forEach(n.tableList,function(t){t.checked||(e=!1)}),e?n.isCheckAll=!0:n.isCheckAll=!1},n.checkAll=function(){var t=!0;angular.forEach(n.tableList,function(e){e.checked||(t=!1)}),angular.forEach(n.tableList,function(e){t?(e.checked=!1,n.isCheckAll=!1):(e.checked=!0,n.isCheckAll=!0)})}}}}]).directive("tdCompile",["$compile",function(t){return function(e,a,n){e.$watch(function(t){return t.$eval(n.tdCompile)},function(n){a.html(n),t(a.contents())(e)})}}]);